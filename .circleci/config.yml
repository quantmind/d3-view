version: 2
jobs:
    tests:
        docker:
          - image: circleci/node:latest-browsers
        steps:
          - checkout
          - run:
              name: install
              command: yarn install
          - run:
              name: test
              command: yarn test
          - run:
              name: remove dev dependencies
              command: npm prune --production
          - run:
              name: run view-require
              command: yarn test-require
          - run:
              name: test d3-view-test
              command: cd packages/d3-view-test && yarn install && yarn test
    coverage:
        docker:
          - image: circleci/node:latest-browsers
        steps:
          - checkout
          - run:
              name: install
              command: yarn install
          - run:
              name: coverage
              command: yarn cover
          - run:
              name: upload coverage
              command: bash <(curl -s https://codecov.io/bash)
    release:
        docker:
          - image: circleci/node:latest-browsers
        steps:
          - checkout
          - run:
              name: install
              command: yarn install && cd packages/d3-view-test && yarn install
          - run:
              name: authenticate
              command: .circleci/authenticate.sh
          - run:
              name: release d3-view
              command: npm run-script release
          - run:
              name: release d3-view-test
              command: cd packages/d3-view-test && npm run-script release



workflows:
  version: 2
  build-deploy:
    jobs:
      - tests
      - coverage
      - release:
          requires:
            - tests
            - coverage
          filters:
            branches:
              only: master
